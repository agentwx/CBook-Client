<style lang="less">
  @import '../../less/mixin';

  page {
    padding-bottom: 100rpx;
    background-color: #f7f7f7;
  }

  .address-selection {
    position: relative;
    .flex-v-center();
    padding: 24rpx 30rpx 30rpx;
    background-color: #fff;

    &:active {
      background-color: @color-active;
    }

    &:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      right: 0;
      height: 6rpx;
      background: #fff url(data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAQDAwQDAwQEBAQFBQQFBwsHBwYGBw4KCggLEA4RERAOEA8SFBoWEhMYEw8QFh8XGBsbHR0dERYgIh8cIhocHRz/2wBDAQUFBQcGBw0HBw0cEhASHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBz/wgARCAAFADQDAREAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAABwMGCP/EABgBAAMBAQAAAAAAAAAAAAAAAAQFBgAC/9oADAMBAAIQAxAAAADVbkE4bhWkElUk35wjppdwtU0h/8QAJRAAAgIABAUFAAAAAAAAAAAAAQIDBAAFERIGBxATITFDcXKC/9oACAEBAAE/AOatuQ2MvqeztMn68jpy8qR2uJ65lGvZVpF+w9McVzPDksuzxvKofgnpXjEtiGNtdrsoOERYkCINFUaAY//EABsRAAICAwEAAAAAAAAAAAAAAAECABEEBRAD/9oACAECAQE/ANUgpm5sGK47VMxivi1cWKABU//EAB0RAAIBBAMAAAAAAAAAAAAAAAECAAMEEBEFISL/2gAIAQMBAT8Au2PnFuoZxuccoauu8VGKJ1AS+yZ//9k=) repeat-x 0 100%;
      background-size: auto 100%;
    }

    .addr-slbd {
      flex: 1;
      margin-left: 20rpx;
      margin-right: 20rpx;
      min-height: 82rpx;
    }

    .addr-slbd2 {
      .flex-v-center();
      font-weight: bold;
    }

    .addr-sltitle {
      font-size: 30rpx;
      font-weight: bold;
      margin-bottom: 10rpx;
    }

    .addr-username {
      margin-right: 20rpx;
    }

    .addr-text {
      font-size: 24rpx;
      color: #888
    }
  }

  .timepicker {
    margin-top: 20rpx;
    margin-bottom: 20rpx;
  }

  .timepicker-bd {
    .flex-v-center();
    justify-content: space-between;
    padding-right: 10rpx;

    .tm-hd {
      font-weight: bold;
    }
  }

  .order-book {
    padding: 6rpx 0;
    .flex();
    justify-content: space-between;
  }

  .order-ft {
    text {
      font-weight: bold;
    }
  }

  .order-action-button {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100rpx;
    font-size: 36rpx;
    color: #fff;
    .g-gradient(60%);
    .flex-center();

    &:active {
      .g-darken-gradient(60%);
    }
  }

  .modal-container {
    .flex-v-center();
    flex-direction: column;

    .md-title {
      font-size: 36rpx;
      margin-bottom: 10rpx;
      margin-top: 16rpx;
    }

    .md-subtitle {
      color: #888;
      margin-bottom: 20rpx;
    }
  }

  .panel-title {
    margin-bottom: 0;
  }
</style>
<template>
  <noticebar
    wx:if="{{orderSource === 'recycle'}}"
    showArrow="false"
  >
    卖书运费由平台承担，你在快递上门时告知快递员运费到付即可
  </noticebar>
  <view class="address-selection" @tap="selectAddress">
    <icon name="geo" color="#777" size="middle"/>
    <view class="addr-slbd" wx:if="{{address !== null}}">
      <view class="addr-sltitle">
        <text class="addr-username">{{address.name}}</text>
        <text class="addr-usertel">{{address.mobile}}</text>
      </view>
      <view class="addr-text">{{address.province}} {{address.city}} {{address.region}}{{address.address}}</view>
    </view>
    <view class="addr-slbd addr-slbd2" wx:if="{{address === null}}">
      {{orderSource === 'recycle' ? '请选择取件地址...' : '请选择收货地址...'}}
    </view>
    <icon name="arrow-right-o" color="#888" customStyle="font-size: 36rpx"/>
  </view>

  <datetimepicker
    wx:if="{{orderSource === 'recycle'}}"
    fields="range"
    timeRange="{{timeRange}}"
    @change="datetimeChange"
  >
    <listitem customClass="timepicker">
      <view class="timepicker-bd">
        <text class="tm-hd">取件时间</text>
        <text>{{deliveryTime}}</text>
      </view>
    </listitem>
  </datetimepicker>

  <panel>
    <view class="panel-title" slot="title">图书列表</view>
    <view class="order-body">
      <repeat for="{{products}}">
        <view class="order-book">
          <view>
            <text>{{item.name}}</text>
            <text>x{{item.COUNT}}</text>
          </view>
          <view wx:if="{{orderSource==='normal'}}">￥{{item.price}}</view>
          <view wx:if="{{orderSource==='recycle'}}">￥{{item.costPrice}}</view>
        </view>
      </repeat>
    </view>
    <view class="panel-footer" slot="footer">
      <view class="order-ft">总共
        <text>{{totalCount}}</text>
        本图书
      </view>
      <view class="order-ft">预计收入
        <text>￥{{totalPrice}}</text>
      </view>
    </view>
  </panel>

  <view class="order-action-button" @tap="submitOrder">
    提交订单
  </view>

  <modal :visible.sync="modalVisible">
    <view class="modal-container">
      <icon name="check" color="#08affe" size="large"></icon>
      <view class="md-title">提交成功</view>
      <view class="md-subtitle">请准备好你的书箱，交给快递员！</view>
    </view>
    <view slot="footer">
      <btn bordered="true" type="plain" size="small" @tap="closeModal">取消</btn>
      <btn size="small" @tap="confirmOrder">确定</btn>
    </view>
  </modal>

</template>

<script>
  import wepy from 'wepy'
  import Panel from '@/components/panel'
  import Modal from '@/components/modal'
  import { toast, getPrevPage } from '../../utils/util'
  import fetch from '../../service/fetch'

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '订单确认',
      usingComponents: {
        datetimepicker: '/components/datetimepicker/index',
        listitem: '/components/listitem/index',
        noticebar: '/components/noticebar/index',
        icon: '/components/icon/index',
        btn: '/components/button/index'
      }
    }

    components = {
      panel: Panel,
      modal: Modal
    }

    data = {
      modalVisible: false,
      deliveryTime: '',
      orderSource: 'normal',
      address: null,
      timeRange: [8, 22],
      products: []
    }

    computed = {
      totalPrice() {
        const isn = this.orderSource === 'normal'
        return this.products
          .reduce((prev, cur) => prev + cur.COUNT * +(isn ? cur.price : cur.costPrice), 0).toFixed(2)
      },
      totalCount() {
        return this.products
          .reduce((prev, cur) => prev + cur.COUNT, 0)
      }
    }

    methods = {
      closeModal() {
        this.modalVisible = false
      },
      selectAddress() {
        this.$navigate('/pages/address/address', {actionMode: 'select'})
      },
      submitOrder() {
        const isRecycleOrder = this.orderSource === 'recycle'
        if (!this.address) {
          return toast.error(`请选择${isRecycleOrder ? '取件' : '收货'}地址`)
        }

        if (isRecycleOrder && !this.deliveryTime) {
          return toast.error('请选择取件时间')
        }

        if (this.orderSource === 'normal') {
          this.createBuyOrder()
        } else if (this.orderSource === 'recycle') {
          this.createRecycleOrder()
        }
        // this.modalVisible = true
      },
      confirmOrder() {
        this.modalVisible = false
        this.$navigate('/pages/orderlist/orderlist')
      },
      datetimeChange (e) {
        this.deliveryTime = e.detail.value
      }
    }

    fillAddress (address) {
      this.address = address
      this.$apply()
    }

    async createRecycleOrder () {
      let params = {
        addressCode: this.address.code,
        appointment: this.deliveryTime,
        isbnList: this.products.map(item => item.isbn),
        income: parseFloat(this.totalPrice)
      }

      await fetch.post('/recover/order/create', params)

      getPrevPage().clear()

      this.$navigate('/pages/recycle/list')
    }

    async createBuyOrder () {
      const origTotalPrice = parseFloat(this.totalPrice)
      const carriage = 6
      const deduction = 17.5
      const discount = 1
      const total = origTotalPrice * discount - deduction + carriage // 总费用 = 总价x折扣 - 星币抵扣 + 运费

      let params = {
        goodsList: this.products.map(item => item.goodsId),
        addressCode: this.address.code,
        original: origTotalPrice,
        total,
        carriage,
        deduction,
        discount
      }

      const res = await fetch.post('/buy/order/create', params)
      if (!res.datas.package && !res.datas.paySign) {
        return toast.error('订单创建失败')
      }
      try {
        await wepy.requestPayment(res.datas)
        toast.success('支付成功')
        setTimeout(() => {
          this.$navigate('/pages/orderlist/orderlist')
        }, 1000)
      } catch (e) {
        this.$navigate('/pages/orderlist/orderlist')
      } finally {
        const prevPage = getPrevPage()
        if (prevPage.route === 'pages/shopcart/shopcart') {
          prevPage.clear()
        }
      }
    }

    onLoad({orderSource, products}) {
      if (orderSource) {
        this.orderSource = orderSource
      }
      this.products = JSON.parse(products)
    }
  }
</script>
