<style lang="less">
  @import '../../less/mixin';

  page {
    padding-bottom: 100rpx;
    background-color: #f7f7f7;
  }

  .address-selection {
    position: relative;
    .flex-v-center();
    padding: 24rpx 30rpx 30rpx;
    background-color: #fff;

    &:active {
      background-color: @color-active;
    }

    &:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      right: 0;
      height: 6rpx;
      background: #fff url(data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAQDAwQDAwQEBAQFBQQFBwsHBwYGBw4KCggLEA4RERAOEA8SFBoWEhMYEw8QFh8XGBsbHR0dERYgIh8cIhocHRz/2wBDAQUFBQcGBw0HBw0cEhASHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBz/wgARCAAFADQDAREAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAABwMGCP/EABgBAAMBAQAAAAAAAAAAAAAAAAQFBgAC/9oADAMBAAIQAxAAAADVbkE4bhWkElUk35wjppdwtU0h/8QAJRAAAgIABAUFAAAAAAAAAAAAAQIDBAAFERIGBxATITFDcXKC/9oACAEBAAE/AOatuQ2MvqeztMn68jpy8qR2uJ65lGvZVpF+w9McVzPDksuzxvKofgnpXjEtiGNtdrsoOERYkCINFUaAY//EABsRAAICAwEAAAAAAAAAAAAAAAECABEEBRAD/9oACAECAQE/ANUgpm5sGK47VMxivi1cWKABU//EAB0RAAIBBAMAAAAAAAAAAAAAAAECAAMEEBEFISL/2gAIAQMBAT8Au2PnFuoZxuccoauu8VGKJ1AS+yZ//9k=) repeat-x 0 100%;
      background-size: auto 100%;
    }

    .addr-slbd {
      flex: 1;
      margin-left: 20rpx;
      margin-right: 20rpx;
      min-height: 82rpx;
    }

    .addr-slbd2 {
      .flex-v-center();
      font-weight: bold;
    }

    .addr-sltitle {
      font-size: 30rpx;
      font-weight: bold;
      margin-bottom: 10rpx;
    }

    .addr-username {
      margin-right: 20rpx;
    }

    .addr-text {
      font-size: 24rpx;
      color: #888
    }
  }

  .timepicker {
    margin-top: 20rpx;
    margin-bottom: 20rpx;
  }

  .timepicker-bd {
    .flex-v-center();
    justify-content: space-between;
    padding-right: 10rpx;

    .tm-hd {
      font-weight: bold;
    }
  }

  .order-book {
    padding: 6rpx 0;
    .flex();
    justify-content: space-between;
  }

  .order-ft {
    text {
      font-weight: bold;
    }
  }

  .order-action-button {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100rpx;
    font-size: 36rpx;
    color: #fff;
    .g-gradient(60%);
    .flex-center();

    &:active {
      .g-darken-gradient(60%);
    }
  }

  .modal-container {
    .flex-v-center();
    flex-direction: column;

    .md-title {
      font-size: 36rpx;
      margin-bottom: 10rpx;
      margin-top: 16rpx;
    }

    .md-subtitle {
      color: #888;
      margin-bottom: 20rpx;
    }
  }

  .panel-title {
    margin-bottom: 0;
  }
</style>
<template>

  <alert showArrow="false">卖书运费由平台承担，你在快递上门时告知快递员运费到会即可</alert>

  <view class="address-selection" @tap="selectAddress">
    <geoicon name="geo" color="#777" size="middle"/>
    <view class="addr-slbd" wx:if="{{address !== null}}">
      <view class="addr-sltitle">
        <text class="addr-username">{{address.name}}</text>
        <text class="addr-usertel">{{address.mobile}}</text>
      </view>
      <view class="addr-text">{{address.province}} {{address.city}} {{address.region}}{{address.address}}</view>
    </view>
    <view class="addr-slbd addr-slbd2" wx:if="{{address === null}}">请选择取件地址...</view>
    <arrowicon name="arrow-right-o" color="#888" style="font-size: 36rpx"/>
  </view>

  <datetimepicker fields="minute" @change="datetimeChange">
    <listitem class="timepicker">
      <view class="timepicker-bd">
        <text class="tm-hd">取件时间</text>
        <text>{{deliveryTime}}</text>
      </view>
    </listitem>
  </datetimepicker>

  <panel>
    <view class="panel-title" slot="title">图书列表</view>
    <view class="order-body">
      <repeat for="{{products}}">
        <view class="order-book">
          <view>
            <text>{{item.name}}</text>
            <text>x{{item.COUNT}}</text>
          </view>
          <view wx:if="{{orderSource=='normal'}}">￥{{item.price}}</view>
          <view wx:if="{{orderSource=='recycle'}}">￥{{item.costPrice}}</view>
        </view>
      </repeat>
    </view>
    <view class="panel-footer" slot="footer">
      <view class="order-ft">总共
        <text>{{totalCount}}</text>
        本图书
      </view>
      <view class="order-ft">预计收入
        <text>￥{{totalPrice}}</text>
      </view>
    </view>
  </panel>

  <view class="order-action-button" @tap="submitOrder">
    提交订单
  </view>

  <modal :visible.sync="modalVisible">
    <view class="modal-container">
      <chkicon name="check" color="#08affe" size="large"></chkicon>
      <view class="md-title">提交成功</view>
      <view class="md-subtitle">请准备好你的书箱，交给快递员！</view>
    </view>
    <view slot="footer">
      <cancelbutton bordered="true" type="plain" size="small" @tap.user="closeModal">取消</cancelbutton>
      <confirmbutton size="small" @tap.user="confirmOrder">确定</confirmbutton>
    </view>
  </modal>

</template>

<script>
  import wepy from 'wepy'
  import Alert from '@/components/alert'
  import Icon from '@/components/icon'
  import Listitem from '@/components/listitem'
  import Panel from '@/components/panel'
  import Modal from '@/components/modal'
  import Button from '@/components/button'
  import { toast } from '../../utils/util'
  import fetch from '../../service/fetch'

  import {getStore} from 'wepy-redux'

  const store = getStore()

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '订单确认',
      usingComponents: {
        datetimepicker: '/components/datetimepicker/index'
      }
    }

    components = {
      alert: Alert,
      geoicon: Icon,
      arrowicon: Icon,
      chkicon: Icon,
      listitem: Listitem,
      panel: Panel,
      modal: Modal,
      cancelbutton: Button,
      confirmbutton: Button
    }

    data = {
      modalVisible: false,
      deliveryTime: '',
      orderSource: 'normal',
      address: null,
      products: []
    }

    computed = {
      totalPrice() {
        const isn = this.orderSource === 'normal'
        return this.products
          .reduce((prev, cur) => prev + cur.COUNT * +(isn ? cur.price : cur.costPrice), 0).toFixed(2)
      },
      totalCount() {
        return this.products
          .reduce((prev, cur) => prev + cur.COUNT, 0)
      }
    }

    methods = {
      closeModal() {
        this.modalVisible = false
      },
      selectAddress() {
        this.$navigate('/pages/address/address', {actionMode: 'select'})
      },
      submitOrder() {
        if (!this.address) {
          return toast.error('请选择取件地址')
        }

        if (!this.deliveryTime) {
          return toast.error('请选择取件时间')
        }

        if (this.orderSource === 'normal') {
          this.createBuyOrder()
        } else {
          this.createRecycleOrder()
        }
        // this.modalVisible = true
      },
      confirmOrder() {
        this.modalVisible = false
        this.$navigate('/pages/orderlist/orderlist')
      },
      datetimeChange (e) {
        this.deliveryTime = e.detail.value
      }
    }

    fillAddress (address) {
      this.address = address
      this.$apply()
    }

    async createRecycleOrder () {
      let params = {
        addressCode: this.address.code,
        appointment: this.deliveryTime,
        isbnList: this.products.map(item => item.isbn),
        income: parseFloat(this.totalPrice)
      }

      await fetch.post('/recover/order/create', params)

      store.dispatch({
        type: 'CLEAR_RECYCLE'
      })

      this.$navigate('/pages/recycle/list')
    }

    async createBuyOrder () {
      let params = {
        addressCode: this.address.code,
        appointment: this.deliveryTime,
        isbnList: this.products.map(item => item.isbn),
        income: parseFloat(this.totalPrice)
      }

      await fetch.post('/buy/order/create', params)

      store.dispatch({
        type: 'CLEAR_CART'
      })

      this.$navigate('/pages/orderlist/orderlist')
    }

    onLoad({orderSource, products}) {
      this.orderSource = orderSource
      this.products = JSON.parse(products)
    }
  }
</script>
