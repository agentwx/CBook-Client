<style lang="less">
  @import '../../styles/mixins/common';
  @import '../../styles/mixins/ellipsis';

  page {
    padding-bottom: 50px;
    background-color: #f7f7f7;
  }

  .notice-bar {
    position: fixed;
    left: 0;
    top: 0;
    right: 0;
    z-index: 20;
  }

  .address-selection {
    position: relative;
    .flex-v-center();
    padding: 12px 15px 15px;
    background-color: #fff;
    margin-bottom: 10px;

    &.recycle {
      margin-top: 35px;
    }

    &:active {
      background-color: @color-active;
    }

    &:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      right: 0;
      height: 3px;
      background: #fff url(data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAQDAwQDAwQEBAQFBQQFBwsHBwYGBw4KCggLEA4RERAOEA8SFBoWEhMYEw8QFh8XGBsbHR0dERYgIh8cIhocHRz/2wBDAQUFBQcGBw0HBw0cEhASHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBz/wgARCAAFADQDAREAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAABwMGCP/EABgBAAMBAQAAAAAAAAAAAAAAAAQFBgAC/9oADAMBAAIQAxAAAADVbkE4bhWkElUk35wjppdwtU0h/8QAJRAAAgIABAUFAAAAAAAAAAAAAQIDBAAFERIGBxATITFDcXKC/9oACAEBAAE/AOatuQ2MvqeztMn68jpy8qR2uJ65lGvZVpF+w9McVzPDksuzxvKofgnpXjEtiGNtdrsoOERYkCINFUaAY//EABsRAAICAwEAAAAAAAAAAAAAAAECABEEBRAD/9oACAECAQE/ANUgpm5sGK47VMxivi1cWKABU//EAB0RAAIBBAMAAAAAAAAAAAAAAAECAAMEEBEFISL/2gAIAQMBAT8Au2PnFuoZxuccoauu8VGKJ1AS+yZ//9k=) repeat-x 0 100%;
      background-size: auto 100%;
    }

    .addr-slbd {
      flex: 1;
      margin-left: 10px;
      margin-right: 10px;
      min-height: 41px;
    }

    .addr-slbd2 {
      .flex-v-center();
      font-weight: bold;
    }

    .addr-sltitle {
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .addr-username {
      margin-right: 10px;
    }

    .addr-text {
      font-size: 12px;
      color: #666
    }
  }

  .timepicker {
    margin-top: 10px;
    margin-bottom: 10px;
  }

  .timepicker-bd {
    .flex-v-center();
    justify-content: space-between;
    padding-right: 5px;

    .tm-hd {
      font-weight: bold;
    }
  }

  .order-book {
    padding: 4px 0;
    .flex();
    justify-content: space-between;

    .book-name {
      flex: 1;
      font-weight: bold;
      .ellipsis();
      margin-right: 15px;
    }

    .book-count {
      width: 30px;
      margin-right: 15px;
    }

    .book-price {
      width: 50px;
      text-align: right;
    }
  }

  .order-ft {
    .flex-v-center();
    white-space: nowrap;

    text {
      font-weight: bold;
    }

    .trade-unit {
      font-size: 12px;
    }

    .trade-amount {
      font-size: 16px;
    }
  }

  .order-action-button {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 50px;
    font-size: 18px;
    color: #fff;
    .g-gradient(60%);
    .flex-center();

    &:active {
      .g-darken-gradient(60%);
    }
  }

  .modal-container {
    .flex-v-center();
    flex-direction: column;

    .md-title {
      font-size: 18px;
      margin-bottom: 5px;
      margin-top: 8px;
    }

    .md-subtitle {
      color: #888;
      margin-bottom: 10px;
    }
  }

  .panel-title {
    margin-bottom: 0;
  }
</style>

<template>
  <notice-bar custom-class="notice-bar" wx:if="{{orderSource === 'recycle'}}">
    <text>卖书运费由平台承担，你在快递上门时告知快递员运费到付即可。</text>
  </notice-bar>

  <view class="address-selection" :class="{recycle: orderSource === 'recycle'}" @tap="selectAddress">
    <icon name="geo" color="#777" size="middle" />
    <view class="addr-slbd" wx:if="{{address}}">
      <view class="addr-sltitle">
        <text class="addr-username">{{address.name}}</text>
        <text class="addr-usertel">{{address.mobile}}</text>
      </view>
      <view class="addr-text">{{address.province}} {{address.city}} {{address.region}} {{address.address}}</view>
    </view>
    <view class="addr-slbd addr-slbd2" wx:if="{{address === null}}">
      {{orderSource === 'recycle' ? '请选择取件地址...' : '请选择收货地址...'}}
    </view>
    <icon name="arrow-right" color="#999" size="17px" />
  </view>

  <datetime-picker
    wx:if="{{orderSource === 'recycle'}}"
    fields="range"
    start-year="{{startYear}}"
    end-year="{{endYear}}"
    start="{{startDateTime}}"
    time-range="{{timeRange}}"
    time-step="{{timeStep}}"
    use-slot="true"
    @change="datetimeChange"
  >
    <list-item bordered="false" custom-class="timepicker">
      <view class="timepicker-bd">
        <text class="tm-hd">取件时间</text>
        <text>{{deliveryTime}}</text>
      </view>
    </list-item>
  </datetime-picker>

  <panel>
    <view class="panel-title" slot="title">图书列表</view>
    <view class="order-body">
      <repeat for="{{products}}" key="index">
        <view class="order-book">
          <view class="book-name">{{item.name}}</view>
          <!--<view class="book-count">x{{item.COUNT}}</view>-->
          <view wx:if="{{orderSource==='normal'}}" class="book-price">￥{{filters.toFixed(item.starPrice || item.price)}}</view>
          <view wx:if="{{orderSource==='recycle'}}" class="book-price">￥{{filters.toFixed(item.costPrice)}}</view>
        </view>
      </repeat>
    </view>
    <view class="panel-footer" slot="footer">
      <view class="order-ft">总共 <text>{{totalCount}}</text> 本图书</view>
      <view class="order-ft">
        <text>{{orderSource==='recycle' ? '预计收入' : '合计'}}</text>
        <view>
          <text class="trade-unit">￥</text>
          <text class="trade-amount">{{totalPrice}}</text>
        </view>
      </view>
    </view>
  </panel>

  <view class="order-action-button" @tap="submitOrder">提交订单</view>

  <modal visible="{{modalVisible}}" show-close="false">
    <view class="modal-container">
      <icon name="check" color="#08affe" size="large"></icon>
      <view class="md-title">提交成功</view>
      <view class="md-subtitle">请准备好你的书箱，交给快递员！</view>
    </view>
    <view slot="footer">
      <btn size="small" @tap="confirmOrder">确定</btn>
    </view>
  </modal>
</template>

<script>
  import wepy from 'wepy'
  import { toast, confirm, getPrevPage, formatDate, parseDate, formatFloat } from '../../utils/util'
  import fetch from '../../service/fetch'
  import filters from '../../filters/number.wxs'

  const getDateTime = (d = new Date()) => {
    if (typeof d === 'string') d = new Date(d)
    return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime()
  }

  // 验证取件时间的有效性
  // const validateTime = timeStr => {
  //   let now = new Date()
  //   let date = timeStr.split(' ')[0]
  //   let hour = timeStr.split(' ')[1].split('-')[0]
  //   let dateTime = parseDate(date).getTime()
  //   let nowTime = getDateTime()
  //
  //   if (dateTime < nowTime) {
  //     return false
  //   } else if (dateTime === nowTime && parseInt(hour) < now.getHours() + 2) {
  //     return false
  //   }
  //   return true
  // }

  // 验证取件时间的有效性
  const validateTime = timeStr => {
    let date = timeStr.split(' ')[0]
    let dateTime = parseDate(date).getTime()
    let nowTime = getDateTime()

    if (dateTime <= nowTime) {
      return false
    } else if (Math.floor((dateTime - nowTime) / (24 * 60 * 60 * 1000)) > 7) {
      return false
    }
    return true
  }

  // 计算时间选择器起始时间节点
  // const getTimeRange = (date, offset = 3) => {
  //   const MAX_HOUR = 14
  //   const MIN_HOUR = 8
  //
  //   let hour = date.getHours()
  //
  //   // 如果当前小时大于14点，直接显示下一天的时间
  //   if (hour >= MAX_HOUR) {
  //     date.setDate(date.getDate() + 1)
  //   }
  //
  //   let dateStr = formatDate(date, 'yyyy-MM-dd')
  //   let hourStr = ''
  //
  //   // 超过时间界限，选择器回归到起点
  //   if (hour >= MAX_HOUR || hour < MIN_HOUR) {
  //     hourStr = `09:00-11:00`
  //   } else {
  //     // 当前时间往后推2小时
  //     hour += offset
  //     hourStr = `${hour}:00-${hour + 1}:00`
  //   }
  //   return `${dateStr} ${hourStr}`
  // }

  // 计算时间选择器起始时间节点
  const getTimeRange = (date) => {
    date.setDate(date.getDate() + 1)
    let dateStr = formatDate(date, 'yyyy-MM-dd')
    let hourStr = '09:00-11:00'
    return `${dateStr} ${hourStr}`
  }

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '订单确认',
      usingComponents: {
        'datetime-picker': '/components/datetime-picker/index',
        'list-item': '/components/list-item/index',
        'notice-bar': '/components/notice-bar/index',
        'icon': '/components/icon/index',
        'btn': '/components/button/index',
        'panel': '/components/panel/index',
        'modal': '/components/modal/index'
      }
    }

    data = {
      modalVisible: false,
      startDateTime: null,
      deliveryTime: '',
      orderSource: 'normal',
      address: null,
      startYear: new Date().getFullYear(),
      endYear: new Date().getFullYear() + (new Date().getMonth() > 10 ? 1 : 0),
      timeRange: [9, 17],
      timeStep: 2,
      products: []
    }

    wxs = {
      filters
    }

    computed = {
      totalPrice() {
        const isn = this.orderSource === 'normal'
        return this.products
          .reduce((prev, cur) => prev + cur.COUNT * +(isn ? (cur.starPrice || cur.price) : cur.costPrice), 0).toFixed(2)
      },
      totalCount() {
        return this.products
          .reduce((prev, cur) => prev + cur.COUNT, 0)
      }
    }

    methods = {
      closeModal() {
        this.modalVisible = false
      },
      selectAddress() {
        this.$navigate('/pages/address/address', { actionMode: 'select' })
      },
      submitOrder() {
        const isRecycleOrder = this.orderSource === 'recycle'
        if (!this.address) {
          return toast.error(`请选择${isRecycleOrder ? '取件' : '收货'}地址`)
        }

        if (isRecycleOrder) {
          if (!this.deliveryTime) {
            return toast.error('请选择取件时间')
          }
          if (!validateTime(this.deliveryTime)) {
            return confirm('取件时间最早明天，最晚不超过7天', '提示信息')
          }
        }

        if (this.orderSource === 'normal') {
          this.createBuyOrder()
        } else if (this.orderSource === 'recycle') {
          this.createRecycleOrder()
        }
      },
      confirmOrder() {
        this.modalVisible = false
        this.$navigate('/pages/recycle/list')
      },
      datetimeChange (e) {
        this.deliveryTime = e.detail.date
      }
    }

    fillAddress (address) {
      this.address = address
      this.$apply()
    }

    async createRecycleOrder () {
      let params = {
        addressCode: this.address.code,
        appointment: this.deliveryTime,
        isbnList: this.products.map(item => item.isbn),
        income: parseFloat(this.totalPrice.toString())
      }

      await fetch.post('/recover/order/create', params)
      getPrevPage().clear({})
      this.modalVisible = true
      this.orderCreated = true
      this.$apply()
    }

    getDeduction () {
      return this.products.reduce((prev, cur) => prev + cur.COUNT * cur.starDeduction, 0)
    }

    async createBuyOrder () {
      const original = parseFloat(this.totalPrice.toString())
      const deduction = this.getDeduction()
      const carriage = 6
      const discount = 1
      const total = formatFloat(original * discount + carriage) // 最终支付金额 = 总价x折扣 - 星币抵扣 + 运费

      let params = {
        goodsList: this.products.map(item => item.goodsId),
        addressCode: this.address.code,
        original,
        total,
        carriage,
        deduction,
        discount
      }

      const res = await fetch.post('/buy/order/create', params)
      if (!res.datas.package || !res.datas.paySign) {
        return toast.error('订单创建失败')
      }

      try {
        await wepy.requestPayment(res.datas)
        toast.success('支付成功')
        setTimeout(() => {
          this.orderCreated = true
          this.$navigate('/pages/orderlist/orderlist')
        }, 1500)
      } catch (e) {
        this.orderCreated = true
        this.$navigate('/pages/orderlist/orderlist', {tabIndex: 1})
      } finally {
        const prevPage = getPrevPage()
        if (prevPage.route === 'pages/shopcart/shopcart') {
          prevPage.clear({})
        }
      }
    }

    async loadAddress () {
      let res = await fetch.post('/user/address/list')
      this.address = res.datas.find(item => item.isDefault === 1)
      this.$apply()
    }

    onShow () {
      if (this.orderCreated) {
        this.$switch('/pages/home/home')
      }
    }

    onLoad ({orderSource, products}) {
      if (orderSource) {
        this.orderSource = orderSource
        if (orderSource === 'recycle') {
          this.startDateTime = getTimeRange(new Date())
        }
      }
      this.orderCreated = false
      this.products = JSON.parse(products)
      this.loadAddress()
    }
  }
</script>
