<style lang="less">
  @import '../../styles/mixin';
  @import '../../styles/ellipsis';

  page {
    padding-bottom: 100rpx;
    background-color: #f7f7f7;
  }

  .address-selection {
    position: relative;
    .flex-v-center();
    padding: 24rpx 30rpx 30rpx;
    background-color: #fff;
    margin-bottom: 20rpx;

    &:active {
      background-color: @color-active;
    }

    &:after {
      content: '';
      position: absolute;
      left: 0;
      bottom: 0;
      right: 0;
      height: 6rpx;
      background: #fff url(data:image/jpg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAQDAwQDAwQEBAQFBQQFBwsHBwYGBw4KCggLEA4RERAOEA8SFBoWEhMYEw8QFh8XGBsbHR0dERYgIh8cIhocHRz/2wBDAQUFBQcGBw0HBw0cEhASHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBwcHBz/wgARCAAFADQDAREAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAABwMGCP/EABgBAAMBAQAAAAAAAAAAAAAAAAQFBgAC/9oADAMBAAIQAxAAAADVbkE4bhWkElUk35wjppdwtU0h/8QAJRAAAgIABAUFAAAAAAAAAAAAAQIDBAAFERIGBxATITFDcXKC/9oACAEBAAE/AOatuQ2MvqeztMn68jpy8qR2uJ65lGvZVpF+w9McVzPDksuzxvKofgnpXjEtiGNtdrsoOERYkCINFUaAY//EABsRAAICAwEAAAAAAAAAAAAAAAECABEEBRAD/9oACAECAQE/ANUgpm5sGK47VMxivi1cWKABU//EAB0RAAIBBAMAAAAAAAAAAAAAAAECAAMEEBEFISL/2gAIAQMBAT8Au2PnFuoZxuccoauu8VGKJ1AS+yZ//9k=) repeat-x 0 100%;
      background-size: auto 100%;
    }

    .addr-slbd {
      flex: 1;
      margin-left: 20rpx;
      margin-right: 20rpx;
      min-height: 82rpx;
    }

    .addr-slbd2 {
      .flex-v-center();
      font-weight: bold;
    }

    .addr-sltitle {
      font-size: 30rpx;
      font-weight: bold;
      margin-bottom: 10rpx;
    }

    .addr-username {
      margin-right: 20rpx;
    }

    .addr-text {
      font-size: 24rpx;
      color: #666
    }
  }

  .timepicker {
    margin-top: 20rpx;
    margin-bottom: 20rpx;
  }

  .timepicker-bd {
    .flex-v-center();
    justify-content: space-between;
    padding-right: 10rpx;

    .tm-hd {
      font-weight: bold;
    }
  }

  .order-book {
    padding: 8rpx 0;
    .flex();
    justify-content: space-between;

    .book-name {
      flex: 1;
      font-weight: bold;
      .ellipsis();
      margin-right: 30rpx;
    }

    .book-count {
      width: 60rpx;
      margin-right: 30rpx;
    }

    .book-price {
      width: 100rpx;
      text-align: right;
    }
  }

  .order-ft {
    .flex-v-center();
    white-space: nowrap;

    text {
      font-weight: bold;
    }

    .trade-unit {
      font-size: 24rpx;
    }

    .trade-amount {
      font-size: 32rpx;
    }
  }

  .order-action-button {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100rpx;
    font-size: 36rpx;
    color: #fff;
    .g-gradient(60%);
    .flex-center();

    &:active {
      .g-darken-gradient(60%);
    }
  }

  .modal-container {
    .flex-v-center();
    flex-direction: column;

    .md-title {
      font-size: 36rpx;
      margin-bottom: 10rpx;
      margin-top: 16rpx;
    }

    .md-subtitle {
      color: #888;
      margin-bottom: 20rpx;
    }
  }

  .panel-title {
    margin-bottom: 0;
  }
</style>
<template>
  <notice-bar
    wx:if="{{orderSource === 'recycle'}}"
    showArrow="false"
  >
    卖书运费由平台承担，你在快递上门时告知快递员运费到付即可
  </notice-bar>
  <view class="address-selection" @tap="selectAddress">
    <icon name="geo" color="#777" size="middle"/>
    <view class="addr-slbd" wx:if="{{address !== null}}">
      <view class="addr-sltitle">
        <text class="addr-username">{{address.name}}</text>
        <text class="addr-usertel">{{address.mobile}}</text>
      </view>
      <view class="addr-text">{{address.province}} {{address.city}} {{address.region}}{{address.address}}</view>
    </view>
    <view class="addr-slbd addr-slbd2" wx:if="{{address === null}}">
      {{orderSource === 'recycle' ? '请选择取件地址...' : '请选择收货地址...'}}
    </view>
    <icon name="arrow-right-o" color="#888" custom-style="font-size: 36rpx"/>
  </view>

  <datetime-picker
    id="datePicker"
    wx:if="{{orderSource === 'recycle'}}"
    fields="range"
    start="{{startDateTime}}"
    time-range="{{timeRange}}"
    @change="datetimeChange"
    @columnchange="columnChange"
  >
    <list-item bordered="false" custom-class="timepicker">
      <view class="timepicker-bd">
        <text class="tm-hd">取件时间</text>
        <text>{{deliveryTime}}</text>
      </view>
    </list-item>
  </datetime-picker>

  <panel>
    <view class="panel-title" slot="title">图书列表</view>
    <view class="order-body">
      <repeat for="{{products}}" key="index">
        <view class="order-book">
          <view class="book-name">{{item.name}}</view>
          <view class="book-count">x{{item.COUNT}}</view>
          <view wx:if="{{orderSource==='normal'}}" class="book-price">￥{{item.price}}</view>
          <view wx:if="{{orderSource==='recycle'}}" class="book-price">￥{{item.costPrice}}</view>
        </view>
      </repeat>
    </view>
    <view class="panel-footer" slot="footer">
      <view class="order-ft">
        总共 <text>{{totalCount}}</text> 本图书
      </view>
      <view class="order-ft">
        {{orderSource==='recycle' ? '预计收入' : '合计'}}
        <view>
          <text class="trade-unit">￥</text>
          <text class="trade-amount">{{totalPrice}}</text>
        </view>
      </view>
    </view>
  </panel>

  <view class="order-action-button" @tap="submitOrder">
    提交订单
  </view>

  <modal visible="{{modalVisible}}" show-close="false">
    <view class="modal-container">
      <icon name="check" color="#08affe" size="large"></icon>
      <view class="md-title">提交成功</view>
      <view class="md-subtitle">请准备好你的书箱，交给快递员！</view>
    </view>
    <view slot="footer">
      <btn size="small" @tap="confirmOrder">确定</btn>
    </view>
  </modal>

</template>

<script>
  import wepy from 'wepy'
  import { toast, getPrevPage, formatDate } from '../../utils/util'
  import fetch from '../../service/fetch'

  const validateTime = timeStr => {
    let now = new Date()
    let date = timeStr.split(' ')[0].replace(/-/g, '/')
    let hour = timeStr.split(' ')[1].split('-')[0]
    if (new Date(date) < new Date(now.getFullYear(), now.getMonth(), now.getDate())) {
      return false
    }

    if (parseInt(hour) <= now.getHours()) {
      return false
    }
    return true
  }

  const getTimeRange = (date, offset = 2) => {
    let now = new Date()
    let hour = now.getHours()
    const MAX_HOUR = 20

    if (hour >= MAX_HOUR) {
      now.setDate(now.getDate() + 1)
    }

    let dateStr = formatDate(now, 'yyyy-MM-dd')
    let hourStr = ''

    if (hour < MAX_HOUR) {
      date = new Date(
        typeof date === 'string'
          ? date.split(' ')[0].replace(/-/g, '/')
          : date
      ).getTime()

      if (date === now.getTime() || date <= new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime()) {
        let hour = now.getHours() + offset
        hourStr = `${hour}:00-${hour + 1}:00`
      }
    } else {
      hourStr = `08:00-09:00`
    }

    return `${dateStr} ${hourStr}`
  }

  const getTimeValue = (range, date, offset = 2) => {
    let now = new Date()
    let dateStr = date.split(' ')[0].replace(/-/g, '/')
    if (new Date(dateStr).getTime() <= new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime()) {
      let hour = now.getHours() + offset
      let hourStr = `${hour}:00-${hour + 1}:00`
      return range.indexOf(hourStr)
    } else {
      return 0
    }
  }

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '订单确认',
      usingComponents: {
        'datetime-picker': '/components/datetime-picker/index',
        'list-item': '/components/list-item/index',
        'notice-bar': '/components/notice-bar/index',
        'icon': '/components/icon/index',
        'btn': '/components/button/index',
        'panel': '/components/panel/index',
        'modal': '/components/modal/index'
      }
    }

    data = {
      modalVisible: false,
      startDateTime: null,
      deliveryTime: '',
      orderSource: 'normal',
      address: null,
      timeRange: [8, 22],
      products: []
    }

    computed = {
      totalPrice() {
        const isn = this.orderSource === 'normal'
        return this.products
          .reduce((prev, cur) => prev + cur.COUNT * +(isn ? cur.price : cur.costPrice), 0).toFixed(2)
      },
      totalCount() {
        return this.products
          .reduce((prev, cur) => prev + cur.COUNT, 0)
      }
    }

    methods = {
      closeModal() {
        this.modalVisible = false
      },
      selectAddress() {
        this.$navigate('/pages/address/address', {actionMode: 'select'})
      },
      submitOrder() {
        const isRecycleOrder = this.orderSource === 'recycle'
        if (!this.address) {
          return toast.error(`请选择${isRecycleOrder ? '取件' : '收货'}地址`)
        }

        if (isRecycleOrder) {
          if (!this.deliveryTime) {
            return toast.error('请选择取件时间')
          }
          if (!validateTime(this.deliveryTime)) {
            return toast.error('取件时间不合法，请重新选择')
          }
        }

        if (this.orderSource === 'normal') {
          this.createBuyOrder()
        } else if (this.orderSource === 'recycle') {
          this.createRecycleOrder()
        }
      },
      confirmOrder() {
        this.modalVisible = false
        this.$navigate('/pages/recycle/list')
      },
      datetimeChange (e) {
        this.deliveryTime = e.detail.date
      },
      columnChange (e) {
        if (e.detail.column < 3) {
          this.startDateTime = getTimeRange(e.detail.date)
          let value = e.detail.values
          let range = e.detail.range
          value[3] = getTimeValue(range[3], e.detail.date)
          this.$wxpage.selectComponent('#datePicker').setValue(value)
        }
      }
    }

    fillAddress (address) {
      this.address = address
      this.$apply()
    }

    async createRecycleOrder () {
      let params = {
        addressCode: this.address.code,
        appointment: this.deliveryTime,
        isbnList: this.products.map(item => item.isbn),
        income: parseFloat(this.totalPrice)
      }

      await fetch.post('/recover/order/create', params)
      getPrevPage().clear({})
      this.modalVisible = true
      this.orderCreated = true
      this.$apply()
    }

    async createBuyOrder () {
      const original = parseFloat(this.totalPrice)
      const carriage = 6
      const deduction = 17.5
      const discount = 1
      const total = original * discount - deduction + carriage // 最终支付金额 = 总价x折扣 - 星币抵扣 + 运费

      let params = {
        goodsList: this.products.map(item => item.goodsId),
        addressCode: this.address.code,
        original,
        total,
        carriage,
        deduction,
        discount
      }

      const res = await fetch.post('/buy/order/create', params)
      if (!res.datas.package || !res.datas.paySign) {
        return toast.error('订单创建失败')
      }

      try {
        await wepy.requestPayment(res.datas)
        toast.success('支付成功')
        setTimeout(() => {
          this.orderCreated = true
          this.$navigate('/pages/orderlist/orderlist')
        }, 1500)
      } catch (e) {
        this.orderCreated = true
        this.$navigate('/pages/orderlist/orderlist', {tabIndex: 1})
        /* const isOk = await confirm('您确定要放弃支付吗?', '', '确定', '继续支付')
        if (isOk) {
          this.orderCreated = true
          this.$navigate('/pages/orderlist/orderlist', {tabIndex: 1})
        } else {
          this.createBuyOrder()
        } */
      } finally {
        const prevPage = getPrevPage()
        if (prevPage.route === 'pages/shopcart/shopcart') {
          prevPage.clear({})
        }
      }
    }

    onShow () {
      if (this.orderCreated) {
        this.$switch('/pages/home/home')
      }
    }

    onLoad ({orderSource, products}) {
      if (orderSource) {
        this.orderSource = orderSource
        if (orderSource === 'recycle') {
          this.startDateTime = getTimeRange(new Date())
        }
      }
      this.orderCreated = false
      this.products = JSON.parse(products)
    }
  }
</script>
