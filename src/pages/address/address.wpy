<style lang="less">
  @import '../../less/mixin';

  page {
    padding-bottom: 100rpx;
    background-color: #f7f7f7;
  }

  .addr-title {
    font-size: 30rpx;
    margin-bottom: 10rpx;
  }

  .addr-username {
    margin-right: 20rpx;
  }

  .addr-text {
    font-size: 26rpx;
    color: #888;
  }

  .address-action-button {
    position: fixed;
    left: 0;
    right: 0;
    bottom: 0;
    height: 100rpx;
    font-size: 36rpx;
    color: #fff;
    .g-gradient(60%);
    .flex-center();

    &:active {
      .g-darken-gradient(60%);
    }
  }

  .addr-left {
    padding: 24rpx 16rpx;
    margin-top: -24rpx;
    margin-bottom: -24rpx;
    margin-left: -16rpx;
    .flex-v-center();
  }

  .addr-right {
    .flex-v-center();
    margin-right: -16rpx;
  }

  .addr-action-item {
    padding: 24rpx 16rpx;
    margin-top: -24rpx;
    margin-bottom: -24rpx;
    margin-left: 24rpx;

    .iconfont {
      margin-right: 6rpx;
      position: relative;
      top: 2rpx;
    }
  }
</style>
<template>
  <repeat for="{{addressList}}">
    <panel @tap.user="selectAddress" :params.sync="item">
      <view class="addr-title">
        <text class="addr-username">{{item.name}}</text>
        <text class="addr-usertel">{{item.mobile}}</text>
      </view>
      <view class="addr-text">{{item.province}}{{item.city}}{{item.region}}{{item.address}}</view>
      <view class="panel-footer" slot="footer">
        <view class="addr-left" @tap.stop="toggleDefault({{item}})">
          <checkbox readonly="true" :checked.sync="item.isDefault" />
          <text style="margin-left: 10rpx;">设为默认</text>
        </view>
        <view class="addr-right">
          <view class="addr-action-item" @tap.stop="editAddress({{item}})">
            <text class="iconfont icon-edit"></text>
            <text>编辑</text>
          </view>
          <view class="addr-action-item" @tap.stop="deleteAddress({{item.code}})">
            <text class="iconfont icon-trash"></text>
            <text>删除</text>
          </view>
        </view>
      </view>
    </panel>
  </repeat>

  <view class="address-action-button" @tap="newAddress">
    新建地址
  </view>

</template>

<script>
  import wepy from 'wepy'
  import Icon from '@/components/icon'
  import Panel from '@/components/panel'
  import Checkbox from '@/components/checkbox'
  import fetch from '../../service/fetch'
  import {toast, confirm, getPrevPage} from '../../utils/util'

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '地址管理'
    }

    components = {
      editicon: Icon,
      delicon: Icon,
      panel: Panel,
      checkbox: Checkbox
    }

    data = {
      addressList: []
    }

    methods = {
      async toggleDefault (item) {
        let params = {
          name: item.name,
          mobile: item.mobile,
          province: item.province,
          city: item.city,
          region: item.region,
          address: item.address,
          isDefault: item.isDefault ? 0 : 1,
          code: item.code
        }
        await fetch.post('/user/address/update', params)
        this.loadData()
      },
      editAddress (item) {
        this.$navigate('/pages/address/new_address', {...item, actionMode: 'edit'})
      },
      async deleteAddress (code) {
        let isOK = await confirm('确定要删除吗?')
        if (isOK) {
          await fetch.post('/user/address/delete', {code})
          this.loadData()
          toast.success('删除成功')
        }
      },
      newAddress () {
        this.$navigate('/pages/address/new_address')
      },
      selectAddress (address) {
        if (this.actionMode === 'select') {
          getPrevPage().fillAddress(address)
          this.$back()
        }
      }
    }

    async loadData () {
      let res = await fetch.post('/user/address/list')
      this.addressList = res.datas.map(item => ({...item, isDefault: item.isDefault === 1}))
      this.$apply()
    }

    onLoad (options) {
      if (options.actionMode) {
        this.actionMode = options.actionMode
      }
      this.loadData()
    }
  }
</script>
