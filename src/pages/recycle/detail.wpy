<style lang="less">
  @import '../../less/mixin';

  page {
    background-color: #f7f7f7;
    padding-bottom: 20rpx;
  }

  .delivery-body {
    .flex-v-center();

    .geo-icon {
      margin-right: 20rpx;
    }
  }

  .delivery-hd {
    font-weight: bold;
    margin-bottom: 12rpx;

    .username {
      margin-right: 20rpx;
    }
  }

  .delivery-address,
  .delivery-picktime {
    color: #888;
    font-size: 26rpx;
    margin-bottom: 10rpx;
  }

  .book-body {
    .flex();
    margin-bottom: 20rpx;
  }

  .book-cover {
    width: 160rpx;
    height: 196rpx;
    margin-right: 30rpx;
    overflow: hidden;

    image {
      width: 100%;
      height: 100%;
    }
  }

  .book-main {
    flex: 1;
    .flex-h-center();
    flex-direction: column;
    justify-content: space-between;
  }

  .book-hd {
    .title {
      margin-bottom: 6rpx;
    }

    .desc {
      color: #999;
    }
  }

  .book-specs {
    .flex();
    justify-content: space-between;

    .price {
      font-size: 30 rpx;
    }

    .status {
      color: #09c8fe;
    }
  }

  .book-title {
    .flex-v-center();

    .icon {
      margin-right: 10rpx;
    }
  }

  .delivery-panel,
  .income-panel {
    padding-top: 0;
    padding-bottom: 0;
  }

  .income-item {
    .flex();
    justify-content: space-between;
    padding: 6rpx 0;

    /*&:first-child {
      color: #888;
    }

    &:last-child {
      font-weight: bold;
    }*/
  }

  .order-panel {
    padding-top: 0;
    padding-bottom: 0;
  }

  .order-item {
    .flex-v-center();
    justify-content: space-between;
    padding: 6rpx 0;
    color: #888;
  }

  .copy-text {
    padding:6rpx 16rpx;
  }

  .action-button {
    padding-top: 20rpx;
    padding-bottom: 20rpx;
    background-color: #fff;
    .flex-center();

    &:active {
      background-color: @color-active;
    }
  }
</style>

<template>
  <stepspanel>
    <steps :stepIndex.sync="stepIndex" :items="stepItems"></steps>
  </stepspanel>
  <deliverypanel class="delivery-panel">
    <view class="delivery-body">
      <geoicon name="geo" class="geo-icon"></geoicon>
      <view class="delivery-main">
        <view class="delivery-hd">
          <text class="username">{{order.orderName}}</text>
          <text class="usertel">{{order.orderMobile}}</text>
        </view>
        <view class="delivery-address">{{order.orderAddress}}</view>
        <view class="delivery-picktime">预约上门取件时间: {{order.appointment}}</view>
      </view>
    </view>
  </deliverypanel>
  <bookspanel>
    <view class="panel-title" slot="title">
      <view class="book-title">
        <libicon name="library"></libicon>
        <text>图书列表</text>
      </view>
    </view>
    <repeat for="{{order.bookInfos}}">
      <view class="book-body">
        <view class="book-cover">
          <image src="{{item.smallIcon}}" lazyload="true"></image>
        </view>
        <view class="book-main">
          <view class="book-hd">
            <view class="title">{{item.name}}</view>
            <view class="desc">{{item.press}}</view>
          </view>
          <view class="book-specs">
            <text class="price">￥{{item.costPrice}}</text>
            <text class="status">{{item.bookStatusText}}</text>
          </view>
        </view>
      </view>
    </repeat>
  </bookspanel>
  <incomepanel class="income-panel">
    <view class="income-item">
      <text>预计收入</text>
      <text>￥{{order.income}}</text>
    </view>
    <!--<view class="income-item">
      <text>实际收入</text>
      <text>￥{{order.income}}</text>
    </view>-->
  </incomepanel>
  <orderpanel class="order-panel">
    <view class="order-item">
      <text>订单编号：{{order.orderCode}}</text>
      <text @tap="copyOrderNum" class="copy-text">复制</text>
    </view>
    <view class="order-item">
      <text>创建时间：{{order.createTime}}</text>
    </view>
  </orderpanel>
  <view class="action-button" @tap="callService">
    <serviceicon name="service" />
    <text>召唤客服</text>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import Panel from '@/components/panel'
  import Steps from '@/components/steps'
  import Icon from '@/components/icon'

  import { toast } from '../../utils/util'

  const BOOK_STATUS_MAP = {
    0: '待审核',
    1: '审核通过'
  }

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '回收订单详情'
    }

    components = {
      stepspanel: Panel,
      deliverypanel: Panel,
      bookspanel: Panel,
      incomepanel: Panel,
      orderpanel: Panel,
      steps: Steps,
      libicon: Icon,
      geoicon: Icon,
      serviceicon: Icon
    }

    data = {
      stepItems: ['线上审核', '物流取件', '平台取件', '验收书籍', '书费到账'],
      order: {}
    }

    computed = {
      stepIndex () {
        return this.order.orderStatus || 0
      }
    }

    methods = {
      async copyOrderNum () {
        await wepy.setClipboardData({data: this.order.orderCode})
        toast.success('复制成功')
      },
      callService () {
        wx.makePhoneCall({
          phoneNumber: '13746584675'
        })
      }
    }

    onLoad({ order }) {
      if (order) {
        order = JSON.parse(order)
        order.bookInfos = order.bookInfos.map(item =>
          ({...item, bookStatusText: BOOK_STATUS_MAP[item.bookStatus]})
        )
        this.order = order
      }
    }
  }
</script>
