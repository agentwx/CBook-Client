<style lang="less">
  @import '../../styles/mixin';

  .manual-panel {
    margin: 25px 20px;
    padding: 20px 25px;
    border-radius: 16px;
    box-shadow: 0 0 24px rgba(0,0,0,.1);
  }

  .manual-hd {
    text-align: center;
    margin-top: 15px;
    margin-bottom: 20px;
    font-size: 15px;

    .title {
      color: #888;
      margin-bottom: 6px;
    }

    .text {
      font-weight: bold;
      margin-bottom: 3px;
    }
  }

  .manual-hint-img {
    text-align: center;

    image {
      width: 100%;
      height: 121px;
      max-width: 280px;
    }
  }

  .manual-field {
    margin-top: 20px;
    margin-bottom: 20px;
  }

  .manual-input {
    padding: 6px 12px;
    background-color: #eee;
    text-align: center;
    border-radius: 8px;
    height: 42px;
  }

  .manual-action {
    .flex();

    btn {
      flex: 1;
    }
  }
</style>

<template>
  <view class="manual-panel">
    <view class="manual-hd">
      <view class="title">添加书箱</view>
      <view class="text">请输入13位或10位ISBN码</view>
      <view class="text">不含“-”符号</view>
    </view>
    <view class="manual-hint-img">
      <image src="../../images/manual_hint.png"></image>
    </view>
    <view class="manual-field">
      <input type="text" class="manual-input" value="{{isbn}}" placeholder="请输入书箱的ISBN号" @input="changeIsbn" />
    </view>
    <view class="manual-action">
      <btn type="plain" @tap="onCancel">取消</btn>
      <btn style="margin-left: 15px;" @tap="onConfirm">确认</btn>
    </view>
  </view>
</template>

<script>
  import wepy from 'wepy'
  import fetch from '../../service/fetch'
  import { toast, confirm } from '../../utils/util'

  import {getStore} from 'wepy-redux'

  const store = getStore()

  export default class Index extends wepy.page {
    config = {
      navigationBarTitleText: '回收给星月童书 手动输入',
      usingComponents: {
        btn: '/components/button/index'
      }
    }

    components = {
    }

    data = {
      isbn: null
    }

    methods = {
      onCancel () {
        this.$back()
      },
      async onConfirm () {
        if (!this.isbn) {
          return toast.error('请输入书籍的isbn号')
        }
        const isExist = store.getState().recycles.find(item => item.isbn === this.isbn)
        if (isExist) {
          return toast.error('该图书已经扫描过')
        }
        let res = await fetch.post('/bookinfo/base', { isbn: this.isbn })
        store.dispatch({
          type: 'ADD_RECYCLE',
          payload: {
            product: res.datas
          }
        })
        const isOK = await confirm('添加成功，请选择下一步', '', '回收列表', '继续填写')
        if (isOK) {
          this.$navigate('/pages/recycle/order')
        } else {
          this.isbn = null
          this.$apply()
        }
      },
      changeIsbn (e) {
        this.isbn = e.detail.value
      }
    }

    onLoad() {
    }
  }
</script>
